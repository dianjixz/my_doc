å‰è¨€
 é€šå¸¸æ¥è¯´ï¼Œäº§å“çš„é©±åŠ¨ç¨‹åºä¸éœ€è¦ç¼–å†™ï¼ŒLinuxå†…æ ¸æä¾›äº†è¶³å¤Ÿå®Œå–„çš„é©±åŠ¨ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚ä½†æ˜¯ï¼Œæœ¬ç€è¿½æ±‚è¿›æ­¥ã€å®äº‹æ±‚æ˜¯ã€å¤©å¤©å‘ä¸Šçš„ç†å¿µï¼ˆxian de dan tengï¼‰ï¼Œæœ€ç»ˆå®Œæˆäº†æœ¬é¸¿ç¯‡å·¨ä½œä¹‹USBæ‘„åƒå¤´é©±åŠ¨ï¼ˆUVCï¼‰ï¼Œæ­£æ‰€è°“ï¼šå­¦å¥½æ•°ç†åŒ–ä»¥åŠUVCï¼Œèµ°éå¤©ä¸‹å…¨ä¸æ€•ã€‚çæ‰¯åˆ°æ­¤ä¸ºæ­¢ï¼Œæ¥ä¸‹æ¥å¼€å§‹è®¤çœŸçš„è®°å½•uvcé©±åŠ¨å­¦ä¹ è¿‡ç¨‹ã€‚é©±åŠ¨ä¸å®Œå–„ï¼Œè¿˜æœ‰å¾ˆå¤šä¸å‡†ç¡®çš„åœ°æ–¹ï¼Œæœ›å„ä½ä¸åèµæ•™ ğŸ˜„ï¼Œæœ€åï¼Œæå‰æ„Ÿè°¢å„ä½çš„é˜…è¯»ã€‚

ä¸€ã€uvcé©±åŠ¨ç®€è¿°
 UVCå…¨ç§°ä¸ºUSB Video Classï¼Œå³ï¼šUSBè§†é¢‘ç±»ï¼Œæ˜¯ä¸€ç§ä¸ºUSBè§†é¢‘æ•è·è®¾å¤‡å®šä¹‰çš„åè®®æ ‡å‡†ã€‚æ˜¯Microsoftä¸å¦å¤–å‡ å®¶è®¾å¤‡å‚å•†è”åˆæ¨å‡ºçš„ä¸ºUSBè§†é¢‘æ•è·è®¾å¤‡å®šä¹‰çš„åè®®æ ‡å‡†ï¼Œå·²æˆä¸ºUSB orgæ ‡å‡†ä¹‹ä¸€ã€‚

 å¦‚ä»Šçš„ä¸»æµæ“ä½œç³»ç»Ÿ(å¦‚Windows XP SP2 and later, Linux 2.4.6 and later, MacOS 10.5 and later)éƒ½å·²æä¾›UVCè®¾å¤‡é©±åŠ¨ï¼Œå› æ­¤ç¬¦åˆUVCè§„æ ¼çš„ç¡¬ä»¶è®¾å¤‡åœ¨ä¸éœ€è¦å®‰è£…ä»»ä½•çš„é©±åŠ¨ç¨‹åºä¸‹å³å¯åœ¨ä¸»æœºä¸­æ­£å¸¸ä½¿ç”¨ã€‚ä½¿ç”¨UVCæŠ€æœ¯çš„åŒ…æ‹¬æ‘„åƒå¤´ã€æ•°ç ç›¸æœºã€ç±»æ¯”å½±åƒè½¬æ¢å™¨ã€ç”µè§†æ£’åŠé™æ€å½±åƒç›¸æœºç­‰è®¾å¤‡ã€‚

 æœ€æ–°çš„UVCç‰ˆæœ¬ä¸ºUVC 1.5ï¼Œç”±USB Implementers Forumå®šä¹‰åŒ…æ‹¬åŸºæœ¬åè®®åŠè´Ÿè½½æ ¼å¼ã€‚

 ç½‘ç»œæ‘„åƒå¤´æ˜¯ç¬¬ä¸€ä¸ªæ”¯æŒUVCè€Œä¸”ä¹Ÿæ˜¯æ•°é‡æœ€å¤šçš„UVCè®¾å¤‡ï¼Œæ“ä½œç³»ç»Ÿåªè¦æ˜¯ Windows XP SP2 ä¹‹åçš„ç‰ˆæœ¬éƒ½å¯ä»¥æ”¯æŒ UVCï¼Œå½“ç„¶ Vista å°±æ›´ä¸ç”¨è¯´äº†ã€‚Linuxç³»ç»Ÿè‡ª2.4ä»¥åçš„å†…æ ¸éƒ½æ”¯æŒäº†å¤§é‡çš„è®¾å¤‡é©±åŠ¨ï¼Œå¹¶å¯ä»¥æ”¯æŒUVCè®¾å¤‡ã€‚

äºŒã€uvcé©±åŠ¨æ¡†æ¶æ­å»º
2.1 ç†ç†æ€è·¯
 UVCé©±åŠ¨é¦–å…ˆæ˜¯å±äºUSBé©±åŠ¨ä¸‹çš„ä¸€ç§ï¼ŒUSBé©±åŠ¨å‘ä¸Šèƒ½å‘ç°æ›´å¤§çš„é©±åŠ¨ç±»ï¼šå­—ç¬¦è®¾å¤‡é©±åŠ¨ã€‚æ‰€ä»¥ï¼Œè€ƒè™‘é¦–å…ˆåº”è¯¥ä»å­—ç¬¦è®¾å¤‡é©±åŠ¨å…¥æ‰‹ã€‚

2.2 å­—ç¬¦è®¾å¤‡é©±åŠ¨åˆ†æ


 æ ¹æ®linuxå­—ç¬¦è®¾å¤‡é©±åŠ¨çš„å¸¸è§å¥—è·¯ï¼ŒAPPåœ¨åº”ç”¨å±‚è°ƒç”¨readã€writeã€openç­‰æ¥å£ï¼Œè°ƒç”¨åº“å‡½æ•°ï¼Œè§¦å‘swiè½¯ä»¶å¼‚å¸¸ï¼Œè¿›å…¥å†…æ ¸ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åˆ°é©±åŠ¨ç¨‹åºçš„openã€readã€writeç­‰ç­‰ã€‚

2.3 UVCå…¥å£å‡½æ•°
 æ¥ä¸‹æ¥æ­£å¼è¿›å…¥åˆ°UVCé©±åŠ¨çš„åˆ†æï¼Œé¦–å…ˆï¼Œéœ€è¦ä¸€ä¸ªå…¥å£å‡½æ•°ä»¥åŠå‡ºå£å‡½æ•°ã€‚ç”±äºUVCå±äºUSBè®¾å¤‡ï¼Œæ‰€ä»¥åœ¨å…¥å£å‡½æ•°ä¸­æ³¨å†Œusb_driverï¼š

static int myuvc_init(void)
{
    usb_register(&myuvc_driver);
    return 0;
}

static void myuvc_exit(void)
{
    usb_deregister(&myuvc_driver);
}

module_init(myuvc_init);
module_exit(myuvc_exit);
MODULE_LICENSE("GPL");
1
2
3
4
5
6
7
8
9
10
11
12
13
14
 è¿™é‡Œçš„usb_driveråº”å½“åŒ…å«å¦‚ä¸‹æˆå‘˜ï¼š

static struct usb_driver myuvc_driver = {
    .name       = "myuvc",
    .probe      = myuvc_probe,
    .disconnect = myuvc_disconnect,
    .id_table   = myuvc_ids,
};
1
2
3
4
5
6
 å½“åœ¨ç³»ç»Ÿä¸­insmodè£…è½½è¯¥é©±åŠ¨ç¨‹åºæ—¶ï¼Œä¼šåœ¨å…¥å£å‡½æ•°ç›´æ¥æ³¨å†Œusb_drvierç»“æ„ä½“ï¼Œé€šè¿‡æ¯”è¾ƒè®¾å¤‡æä¾›çš„INFOï¼Œå’Œid_tableæ¯”è¾ƒï¼Œè‹¥åŒ¹é…ï¼Œåˆ™è¡¨æ˜é©±åŠ¨æ”¯æŒè¯¥usbï¼Œuvcé©±åŠ¨çš„id_tableå¯ç”±USBçš„æ¥å£è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

static struct usb_device_id myuvc_ids[] = {
	/* Generic USB Video Class */
	{ USB_INTERFACE_INFO(USB_CLASS_VIDEO, 1, 0) },  /* VideoControl Interface */
    { USB_INTERFACE_INFO(USB_CLASS_VIDEO, 2, 0) },  /* VideoStreaming Interface */
	{}
};
1
2
3
4
5
6
 è¿™é‡Œä»‹ç»ä¸€ä¸‹ï¼Œä¸€ä¸ªuvcæ‘„åƒå¤´è®¾å¤‡è¢«Linuxåˆ†ä¸º2ä¸ªé€»è¾‘æ¥å£ï¼Œåˆ†åˆ«ä¸ºæ§åˆ¶æ¥å£ï¼šVideoControl Interfaceï¼›ä»¥åŠä¼ è¾“æ¥å£ï¼šVideoStreaming Interfaceã€‚USBé€šè¿‡è®¾å¤‡æè¿°ç¬¦çš„å½¢å¼ï¼Œæ§åˆ¶å’Œç®¡ç†è®¾å¤‡ã€‚åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡lsusbæŸ¥çœ‹æŸä¸€çº§çš„æè¿°ç¬¦ï¼Œæ¯”å¦‚ lsusb -v -d 0x1e4e: â€œbBitsPerPixelâ€ï¼Œå¯ä»¥æŸ¥çœ‹ä¼ è¾“æ•°æ®çš„æ ¼å¼ï¼šå­—èŠ‚æ¯åƒç´ ã€‚

 æœ€åï¼Œç›¸åº”çš„ï¼Œåœ¨å‡ºå£å‡½æ•°ä¸­åº”å½“é‡Šæ”¾æ³¨å†Œçš„usb_driveré©±åŠ¨ã€‚

2.4 uvcè®¾å¤‡
 åœ¨é©±åŠ¨å…¥å£å‡½æ•°ä¸­ï¼Œæ¯”è¾ƒid_tableï¼Œè‹¥åŒ¹é…ï¼Œåˆ™è°ƒç”¨usb_driverçš„probeå‡½æ•°ã€‚probeå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š

static int myuvc_probe(struct usb_interface *intf,
		     const struct usb_device_id *id)
{
    static int cnt = 0;
	struct usb_device *dev = interface_to_usbdev(intf);

    myuvc_udev = dev;
    
    if (cnt == 1)
    {
        myuvc_control_intf = intf->cur_altsetting->desc.bInterfaceNumber;
    }
    else if (cnt == 2)
    {
        myuvc_streaming_intf = intf->cur_altsetting->desc.bInterfaceNumber;
    }
    
    if (cnt == 2)
    {
        /* 1. åˆ†é…ä¸€ä¸ªvideo_deviceç»“æ„ä½“ */
        myuvc_vdev = video_device_alloc();
    
        /* 2. è®¾ç½® */
        myuvc_vdev->release = myuvc_release;
        
        myuvc_vdev->fops    = &myuvc_fops;
        
        myuvc_vdev->ioctl_ops = &myuvc_ioctl_ops;
    
        /* 3. æ³¨å†Œ */
        video_register_device(myuvc_vdev, VFL_TYPE_GRABBER, -1);
    }
    return 0;
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
 ä¸Šæ–‡æåˆ°è¿‡ï¼Œuvcæœ‰ä¸¤ä¸ªé€»è¾‘æ¥å£ï¼Œä¸€ä¸ªç”¨äºä¼ è¾“ï¼Œä¸€ä¸ªç”¨äºæ§åˆ¶ã€‚æ‰€ä»¥ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªuvcè®¾å¤‡åº”å½“è¢«æ³¨å†Œäº†ä¸¤æ¬¡ã€‚åœ¨è¿™é‡Œï¼Œé€šè¿‡åŠ¨æ€æ³¨å†Œçš„æ–¹æ³•ï¼Œè®¾ç½®usb_deviceã€‚ç”±äºåœ¨å†…æ ¸ä¸­ï¼Œè¦æ±‚å¿…é¡»æœ‰usb_releaseå‡½æ•°ï¼Œæ‰€ä»¥æ·»åŠ ï¼Œä½†æ˜¯ä¸ºä¸€ä¸ªç©ºå‡½æ•°ã€‚æœ€ä¸»è¦çš„æ˜¯fopsä»¥åŠioctl_opsã€‚

static const struct v4l2_file_operations myuvc_fops = {
	.owner		= THIS_MODULE,
    .open       = myuvc_open,
    .release    = myuvc_close,
    .mmap       = myuvc_mmap,
    .ioctl      = video_ioctl2, 	/* V4L2 ioctl handler */
    .poll       = myuvc_poll,		
};
1
2
3
4
5
6
7
8
 APPåœ¨åº”ç”¨ç©ºé—´è°ƒç”¨openå‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°uvc_openï¼Œæ‰“å¼€uvcæ‘„åƒå¤´è®¾å¤‡ï¼Œé€šè¿‡mmapæ˜ å°„è™šæ‹Ÿåœ°å€ï¼Œç”¨äºå­˜æ”¾æ‘„åƒå¤´ä¼ è¾“çš„æ•°æ®é˜Ÿåˆ—ï¼Œæ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸€ä¸‹è®¾å¤‡çš„ioctl_opsã€‚

2.4.1 uvcè®¾å¤‡çš„ioctl_ops
 uvcè®¾å¤‡çš„ioctl_opsç”±14ä¸ªé‡è¦æ“ä½œå‡½æ•°ç»„æˆï¼Œä»–ä»¬çš„ä½œç”¨å¦‚ä¸‹æ³¨é‡Šï¼š

static const struct v4l2_ioctl_ops myuvc_ioctl_ops = {
        // è¡¨ç¤ºå®ƒæ˜¯ä¸€ä¸ªæ‘„åƒå¤´è®¾å¤‡
        .vidioc_querycap      = myuvc_vidioc_querycap,

        /* ç”¨äºåˆ—ä¸¾ã€è·å¾—ã€æµ‹è¯•ã€è®¾ç½®æ‘„åƒå¤´çš„æ•°æ®çš„æ ¼å¼ */
        .vidioc_enum_fmt_vid_cap  = myuvc_vidioc_enum_fmt_vid_cap,
        .vidioc_g_fmt_vid_cap     = myuvc_vidioc_g_fmt_vid_cap,
        .vidioc_try_fmt_vid_cap   = myuvc_vidioc_try_fmt_vid_cap,
        .vidioc_s_fmt_vid_cap     = myuvc_vidioc_s_fmt_vid_cap,
        
        /* ç¼“å†²åŒºæ“ä½œ: ç”³è¯·/æŸ¥è¯¢/æ”¾å…¥é˜Ÿåˆ—/å–å‡ºé˜Ÿåˆ— */
        .vidioc_reqbufs       = myuvc_vidioc_reqbufs,
        .vidioc_querybuf      = myuvc_vidioc_querybuf,
        .vidioc_qbuf          = myuvc_vidioc_qbuf,
        .vidioc_dqbuf         = myuvc_vidioc_dqbuf,
    
        /* æŸ¥è¯¢/è·å¾—/è®¾ç½®å±æ€§ */
        .vidioc_queryctrl     = myuvc_vidioc_queryctrl,
        .vidioc_g_ctrl        = myuvc_vidioc_g_ctrl,
        .vidioc_s_ctrl        = myuvc_vidioc_s_ctrl,
        
        // å¯åŠ¨/åœæ­¢
        .vidioc_streamon      = myuvc_vidioc_streamon,
        .vidioc_streamoff     = myuvc_vidioc_streamoff,   
};
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
 ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºuvcè®¾å¤‡çš„ioctl_opsæ¶µç›–äº†æ•´ä¸ªå¼€å§‹åˆ°ä¼ è¾“å†åˆ°ç»“æŸçš„æµç¨‹ï¼Œioctl_opsuvcæ˜¯é‡ç‚¹åˆ†æå¯¹è±¡ï¼Œæ¥ä¸‹æ¥é€šè¿‡åˆ†æè¯¥æ§åˆ¶ç»“æ„ä½“ï¼Œæ¥æ­ç¤ºuvcæ‘„åƒå¤´é©±åŠ¨çš„ç¥ç§˜é¢çº±~

ä¸‰ã€ä¼ è¾“æµç¨‹
 è®²è§£çš„æµç¨‹åˆ†ä¸ºæ§åˆ¶æ¥å£ï¼šVideoControl Interfaceï¼›ä»¥åŠä¼ è¾“æ¥å£ï¼šVideoStreaming Interfaceã€‚é€šè¿‡ä¼ è¾“æ¥å£å®Œæˆï¼šåº•å±‚æ•°æ®çš„æœé›†ï¼Œä¸ŠæŠ¥ï¼Œä¼ è¾“ç­‰è¿‡ç¨‹ã€‚é€šè¿‡æ§åˆ¶æ¥å£å®Œæˆï¼šéŸ³é‡æ§åˆ¶ï¼Œäº®åº¦è°ƒèŠ‚ç­‰å…·ä½“å‚æ•°æ§åˆ¶ã€‚

3.1 ä¼ è¾“æµç¨‹
 å½“APPæœ€ç»ˆè°ƒç”¨åˆ°é©±åŠ¨ç¨‹åºopenã€‚

 é¦–å…ˆæ˜¯æ‘„åƒå¤´æ ¼å¼çš„è®¾ç½®æ“ä½œï¼š

myuvc_vidioc_querycapï¼Œè¡¨æ˜è®¾å¤‡ä¸ºè§†é¢‘æ•æ‰è®¾å¤‡ã€‚

myuvc_vidioc_enum_fmt_vid_capï¼Œåˆ—ä¸¾é©±åŠ¨æ”¯æŒå“ªäº›æ ¼å¼ã€‚ç®€å•è®¾ç½®ä¸ºæ”¯æŒä¸€ç§æ ¼å¼YUYVã€‚

myuvc_vidioc_g_fmt_vid_capï¼Œè¿”å›å½“å‰æ‰€ä½¿ç”¨çš„æ ¼å¼ã€‚

myuvc_vidioc_try_fmt_vid_capï¼Œæµ‹è¯•é©±åŠ¨ç¨‹åºæ˜¯å¦æ”¯æŒæŸç§æ ¼å¼, å¼ºåˆ¶è®¾ç½®è¯¥æ ¼å¼ã€‚

myuvc_vidioc_s_fmt_vid_capï¼Œç¡®è®¤ç¬¬å››æ­¥å°è¯•çš„æ ¼å¼ï¼Œå¹¶è¿›ä¸€æ­¥è®¾ç½®ç»†èŠ‚ã€‚

æ¥ä¸‹æ¥æ˜¯ä¸ºä¼ è¾“å‡†å¤‡ç©ºé—´å’Œé˜Ÿåˆ—ï¼š

myuvc_vidioc_reqbufsï¼Œè‹¥å¹²ä¸ªç¼“å­˜, APPå°†ä»è¿™äº›ç¼“å­˜ä¸­è¯»åˆ°è§†é¢‘æ•°æ®ã€‚

myuvc_vidioc_querybufï¼ŒæŸ¥è¯¢ç¼“å­˜çŠ¶æ€, æ¯”å¦‚åœ°å€ä¿¡æ¯(APPå¯ä»¥ç”¨mmapè¿›è¡Œæ˜ å°„) ã€‚

myuvc_mmapï¼Œæ­¤å‡½æ•°åœ¨device_fopsä¸­ï¼Œå°†åˆ†é…å¥½çš„ç¼“å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾›APPç›´æ¥æ“ä½œã€‚

myuvc_vidioc_qbufï¼ŒæŠŠç¼“å†²åŒºæ”¾å…¥é˜Ÿåˆ—, åº•å±‚çš„ç¡¬ä»¶æ“ä½œå‡½æ•°å°†ä¼šæŠŠæ•°æ®æ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—çš„ç¼“å­˜ã€‚



ä¸‡äº‹ä¿±å¤‡ï¼Œå¼€å§‹ä¼ è¾“ï¼š

myuvc_vidioc_streamonï¼Œå¯åŠ¨ä¼ è¾“ã€‚

myuvc_pollï¼ŒAPPè°ƒç”¨POLL/selectæ¥ç¡®å®šç¼“å­˜æ˜¯å¦å°±ç»ª(æœ‰æ•°æ®) ã€‚

myuvc_vidioc_dqbufï¼Œè‹¥æœ‰æ•°æ®ï¼Œåˆ™æŠŠç¼“å­˜ä»é˜Ÿåˆ—å–å‡ºï¼Œmmapæ˜ å°„è¿‡å†…å­˜ï¼Œæ‰€ä»¥APPå¯ç›´æ¥æ“ä½œç¼“å­˜ã€‚

é‡å¤æŸ¥è¯¢ã€è·å–â€¦

myuvc_vidioc_streamoffï¼Œä¼ è¾“ç»“æŸï¼Œåœæ­¢ã€‚



3.2 æ§åˆ¶æµç¨‹
 æ§åˆ¶ç›¸å¯¹ç®€å•ï¼š

myuvc_vidioc_queryctrlï¼ŒæŸ¥è¯¢æƒ³è¦è®¾ç½®çš„å±æ€§ï¼Œåœ¨è®¾å¤‡ä¸­æ˜¯å¦å¯ç”¨ã€‚
myuvc_vidioc_g_ctrlï¼Œä»è®¾å¤‡è·å–å±æ€§ã€‚
myuvc_vidioc_s_ctrlï¼Œå‘è®¾å¤‡è®¾ç½®å±æ€§ã€‚
å››ã€æ­£å¼ç¼–å†™
 åœ¨æ¸…æ¥šäº†æ•´ä¸ªuvcçš„ä¼ è¾“ä»¥åŠæ§åˆ¶æµç¨‹ä¹‹åï¼Œå¼€å§‹åœ¨æ¡†æ¶ä¸‹å¼€å§‹ç¼–å†™uvcé©±åŠ¨ã€‚ç¼–å†™æŒ‰ç…§æ¡†æ¶æ‰€ç½—åˆ—çš„æ­¥éª¤ï¼Œä¾æ¬¡å¡«å……æ¡†æ¶ï¼Œæœ€åå°†å®Œå–„ä¸ºä¸€ä¸ªå¯ç”¨çš„uvcé©±åŠ¨ã€‚

 ä¸ç®¡æ˜¯vsæ¥å£ï¼ˆä¼ è¾“ï¼‰ï¼Œè¿˜æ˜¯vcæ¥å£ï¼ˆæ§åˆ¶ï¼‰ï¼Œéƒ½æ˜¯ä»è®¾å¤‡çš„openå‡½æ•°ä½œä¸ºå…¥å£ï¼Œæš‚æ—¶ä¸éœ€è¦åšä»€ä¹ˆå·¥ä½œï¼Œæ‰€ä»¥è®²openå‡½æ•°æš‚å®šä¸ºç©ºã€‚



4.1 æ•°æ®ä¼ è¾“
4.1.1 æ ¼å¼è®¾ç½®
myuvc_vidioc_querycapï¼Œè¡¨æ˜è®¾å¤‡ä¸ºè§†é¢‘æ•æ‰è®¾å¤‡ã€‚

static int myuvc_vidioc_querycap(struct file *file, void  *priv,
					struct v4l2_capability *cap)
{    
    memset(cap, 0, sizeof *cap);
    strcpy(cap->driver, "myuvc");
    strcpy(cap->card, "myuvc");
    cap->version = 1;
    
    cap->capabilities = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_STREAMING;
     
    return 0;
}
1
2
3
4
5
6
7
8
9
10
11
12
å‡½æ•°çš„ä»»åŠ¡å°±æ˜¯ç¡®å®šè®¾å¤‡æ˜¯ä¸€ä¸ªè§†é¢‘æ•æ‰è®¾å¤‡ï¼Œä¸”ä¼ è¾“æ–¹å¼æ˜¯è§†é¢‘æµï¼ˆåŒºåˆ«äºè¯»å†™RWï¼‰ã€‚

myuvc_vidioc_enum_fmt_vid_capï¼Œåˆ—ä¸¾é©±åŠ¨æ”¯æŒå“ªäº›æ ¼å¼ã€‚ç®€å•è®¾ç½®ä¸ºæ”¯æŒä¸€ç§æ ¼å¼YUYVã€‚

ä¸ºæ–¹ä¾¿å‰æœŸå¼€å‘ï¼Œåªè®¾ç½®ä¸€ç§æ”¯æŒæ ¼å¼ï¼Œåç»­æ ¼å¼å¯åæœŸæ·»åŠ ã€‚

static int myuvc_vidioc_enum_fmt_vid_cap(struct file *file, void  *priv,
					struct v4l2_fmtdesc *f)
{
    /* äººå·¥æŸ¥çœ‹æè¿°ç¬¦å¯çŸ¥æˆ‘ä»¬ç”¨çš„æ‘„åƒå¤´åªæ”¯æŒ1ç§æ ¼å¼ */
	if (f->index >= 1)
		return -EINVAL;


	strcpy(f->description, "4:2:2, packed, YUYV");
	f->pixelformat = V4L2_PIX_FMT_YUYV;    
	
	return 0;
}
1
2
3
4
5
6
7
8
9
10
11
12
13
 æ”¯æŒä»€ä¹ˆæ ¼å¼å‘¢ï¼ŸæŸ¥çœ‹VideoStreaming Interfaceçš„æè¿°ç¬¦ï¼Œå¾—åˆ°GUIDä¸º"59 55 59 32 00 00 10 00 80 00 00 aa 00 38 9b 71"ï¼Œä¹Ÿå°±æ˜¯YUYVã€‚

myuvc_vidioc_g_fmt_vid_capï¼Œè¿”å›å½“å‰æ‰€ä½¿ç”¨çš„æ ¼å¼ã€‚

static int myuvc_vidioc_g_fmt_vid_cap(struct file *file, void *priv,
					struct v4l2_format *f)
{
    memcpy(f, &myuvc_format, sizeof(myuvc_format));
	return (0);
}
1
2
3
4
5
6
myuvc_vidioc_try_fmt_vid_capï¼Œæµ‹è¯•é©±åŠ¨ç¨‹åºæ˜¯å¦æ”¯æŒæŸç§æ ¼å¼, å¼ºåˆ¶è®¾ç½®è¯¥æ ¼å¼ï¼Œå¹¶è®¾ç½®è¯¥æ ¼å¼ä¸‹çš„å±æ€§å‚æ•°ã€‚

static int myuvc_vidioc_try_fmt_vid_cap(struct file *file, void *priv,
			struct v4l2_format *f)
{
    if (f->type != V4L2_BUF_TYPE_VIDEO_CAPTURE)
    {
        return -EINVAL;
    }
    if (f->fmt.pix.pixelformat != V4L2_PIX_FMT_YUYV)
        return -EINVAL; 
    /* è°ƒæ•´formatçš„width, height, 
     * è®¡ç®—bytesperline, sizeimage
     */

    /* äººå·¥æŸ¥çœ‹æè¿°ç¬¦, ç¡®å®šæ”¯æŒå“ªå‡ ç§åˆ†è¾¨ç‡ */
    f->fmt.pix.width  = frames[frame_idx].width;
    f->fmt.pix.height = frames[frame_idx].height;
    
    f->fmt.pix.bytesperline =
    	(f->fmt.pix.width * bBitsPerPixel) >> 3;
    f->fmt.pix.sizeimage =
    	f->fmt.pix.height * f->fmt.pix.bytesperline;
    
    return 0;
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
è¿™é‡Œåªè®¾ç½®äº†åˆ†è¾¨ç‡ã€‚

myuvc_vidioc_s_fmt_vid_capï¼Œç¡®è®¤ç¬¬å››æ­¥å°è¯•çš„æ ¼å¼ï¼Œå¹¶è¿›ä¸€æ­¥è®¾ç½®ç»†èŠ‚ã€‚

static int myuvc_vidioc_s_fmt_vid_cap(struct file *file, void *priv,
					struct v4l2_format *f)
{
	int ret = myuvc_vidioc_try_fmt_vid_cap(file, NULL, f);
	if (ret < 0)
		return ret;

    memcpy(&myuvc_format, f, sizeof(myuvc_format));
    
    return 0;
}
1
2
3
4
5
6
7
8
9
10
11
 å°†ä¸Šä¸€æ­¥å°è¯•çš„æ ¼å¼å’Œå‚æ•°ï¼Œè®¾ç½®é¡¹SUBæ‘„åƒå¤´ã€‚

4.1.2 ä¸ºä¼ è¾“å‡†å¤‡ç©ºé—´å’Œé˜Ÿåˆ—
myuvc_vidioc_reqbufsï¼Œè‹¥å¹²ä¸ªç¼“å­˜, APPå°†ä»è¿™äº›ç¼“å­˜ä¸­è¯»åˆ°è§†é¢‘æ•°æ®ã€‚

å‡½æ•°éƒ¨åˆ†é‡è¦ä»£ç ç‰‡æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š

int nbuffers = p->count;		//åˆ†é…ç¼“å†²åŒºä¸ªæ•°
int bufsize  = PAGE_ALIGN(myuvc_format.fmt.pix.sizeimage);	//æ¯ä¸ªç¼“å†²åŒºçš„å¤§å°æŒ‰é¡µå¯¹é½
... ...
        /* è¿™äº›ç¼“å­˜æ˜¯ä¸€æ¬¡æ€§ä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥åˆ†é…çš„ */
    memset(&myuvc_queue, 0, sizeof(myuvc_queue));

	INIT_LIST_HEAD(&myuvc_queue.mainqueue);
	INIT_LIST_HEAD(&myuvc_queue.irqqueue);
	
	for (i = 0; i < nbuffers; ++i) {
	    myuvc_queue.buffer[i].buf.index = i;
	    myuvc_queue.buffer[i].buf.m.offset = i * bufsize;
	    myuvc_queue.buffer[i].buf.length = myuvc_format.fmt.pix.sizeimage;
	    myuvc_queue.buffer[i].buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;
	    myuvc_queue.buffer[i].buf.sequence = 0;
	    myuvc_queue.buffer[i].buf.field = V4L2_FIELD_NONE;
	    myuvc_queue.buffer[i].buf.memory = V4L2_MEMORY_MMAP;
	    myuvc_queue.buffer[i].buf.flags = 0;
	    myuvc_queue.buffer[i].state     = VIDEOBUF_IDLE;	//è®¾ç½®ä¸ºç©ºé—²çŠ¶æ€
	    init_waitqueue_head(&myuvc_queue.buffer[i].wait);	//é˜Ÿåˆ—ç­‰å¾…
	}
	
	myuvc_queue.mem = mem;
	myuvc_queue.count = nbuffers;
	myuvc_queue.buf_size = bufsize;
	ret = nbuffers;
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
è¿™é‡Œç”¨åˆ°ä¸€ä¸ªå…³é”®çš„ç¼–ç¨‹æŠ€å·§ï¼Œä¸¤ä¸ªé˜Ÿåˆ—å¤´ç®¡ç†ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—ã€‚å½“æœ‰æ•°æ®æ—¶ï¼Œä»irqqueueå–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œæ”¾å…¥æ•°æ®ã€‚å½“åº”ç”¨ç¨‹åºé€šè¿‡pollæŸ¥è¯¢åˆ°æœ‰æ•°æ®æ—¶ï¼Œä»mainqueueå–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œå–å‡ºæ•°æ®ï¼Œåˆå§‹åŒ–buf1ï¼Œå¹¶å…¥åˆ—é˜Ÿå°¾ã€‚å…·ä½“çš„é˜Ÿåˆ—æ“ä½œè¯·è§æ¿å—äº”ã€é—®é¢˜ä¸è§£å†³;



myuvc_vidioc_querybufï¼ŒæŸ¥è¯¢ç¼“å­˜çŠ¶æ€, æ¯”å¦‚åœ°å€ä¿¡æ¯(APPå¯ä»¥ç”¨mmapè¿›è¡Œæ˜ å°„) ã€‚

éƒ¨åˆ†ä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š

    memcpy(v4l2_buf, &myuvc_queue.buffer[v4l2_buf->index].buf, sizeof(*v4l2_buf));
    
    if (myuvc_queue.buffer[v4l2_buf->index].vma_use_count)
    	v4l2_buf->flags |= V4L2_BUF_FLAG_MAPPED;
    
    switch (myuvc_queue.buffer[v4l2_buf->index].state) {
    	case VIDEOBUF_ERROR:
    	case VIDEOBUF_DONE:
    		v4l2_buf->flags |= V4L2_BUF_FLAG_DONE;
    		break;
    	case VIDEOBUF_QUEUED:
    	case VIDEOBUF_ACTIVE:
    		v4l2_buf->flags |= V4L2_BUF_FLAG_QUEUED;
    		break;
    	case VIDEOBUF_IDLE:
    	default:
    		break;
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
å¯ä»¥çœ‹åˆ°ï¼Œå‡½æ•°ç›´æ¥æ ¹æ®é˜Ÿåˆ—ä¸­ç¼“å­˜çš„ç´¢å¼•ï¼ˆæ•°ç»„ä¸‹æ ‡ï¼‰ï¼Œå–å‡ºç¼“å­˜ï¼Œå¤åˆ¶åˆ°v4l2_bufã€‚é™¤æ­¤ä»¥å¤–ï¼Œå‡½æ•°è¿˜æ›´æ–°äº†ç¼“å­˜çš„çŠ¶æ€ã€‚

myuvc_mmapï¼Œæ­¤å‡½æ•°åœ¨device_fopsä¸­ï¼Œå°†åˆ†é…å¥½çš„ç¼“å­˜æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼Œä¾›APPç›´æ¥æ“ä½œã€‚

å‡½æ•°è°ƒç”¨åˆ°äº†vmaï¼Œéƒ¨åˆ†ä»£ç ï¼š

    for (i = 0; i < myuvc_queue.count; ++i) {
        buffer = &myuvc_queue.buffer[i];
        if ((buffer->buf.m.offset >> PAGE_SHIFT) == vma->vm_pgoff)
            break;
    }
    ... ...
    addr = (unsigned long)myuvc_queue.mem + buffer->buf.m.offset;
    while (size > 0) {
        page = vmalloc_to_page((void *)addr);
    
        /* æŠŠpageå’ŒAPPä¼ å…¥çš„è™šæ‹Ÿåœ°å€æŒ‚æ„ */
        if ((ret = vm_insert_page(vma, start, page)) < 0)
            goto done;
    
        start += PAGE_SIZE;
        addr += PAGE_SIZE;
        size -= PAGE_SIZE;
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
é¦–å…ˆå–å‡ºæ¯ä¸€ä¸ªç¼“å­˜ï¼Œåˆ†åˆ«å¯¹æ¯ä¸€ä¸ªç¼“å­˜ä¸è™šæ‹Ÿåœ°å€ï¼ŒæŒ‰é¡µæŒ‚é’©ã€‚

myuvc_vidioc_qbufï¼ŒæŠŠç¼“å†²åŒºæ”¾å…¥é˜Ÿåˆ—, åº•å±‚çš„ç¡¬ä»¶æ“ä½œå‡½æ•°å°†ä¼šæŠŠæ•°æ®æ”¾å…¥è¿™ä¸ªé˜Ÿåˆ—çš„ç¼“å­˜ã€‚

    /* 1. ä¿®æ”¹çŠ¶æ€ */
    buf->state = VIDEOBUF_QUEUED;
    buf->buf.bytesused = 0;
    
    /* 2. æ”¾å…¥2ä¸ªé˜Ÿåˆ— */
    /* é˜Ÿåˆ—1: ä¾›APPä½¿ç”¨ 
     * å½“ç¼“å†²åŒºæ²¡æœ‰æ•°æ®æ—¶,æ”¾å…¥mainqueueé˜Ÿåˆ—
     * å½“ç¼“å†²åŒºæœ‰æ•°æ®æ—¶, APPä»mainqueueé˜Ÿåˆ—ä¸­å–å‡º
     */
    list_add_tail(&buf->stream, &myuvc_queue.mainqueue);
    
    /* é˜Ÿåˆ—2: ä¾›äº§ç”Ÿæ•°æ®çš„å‡½æ•°ä½¿ç”¨
     * å½“é‡‡é›†åˆ°æ•°æ®æ—¶,ä»irqqueueé˜Ÿåˆ—ä¸­å–å‡ºç¬¬1ä¸ªç¼“å†²åŒº,å­˜å…¥æ•°æ®
     */
    list_add_tail(&buf->irq, &myuvc_queue.irqqueue);
    
    return 0;
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
å¯ä»¥å‘ç°ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¹‹å‰æåˆ°çš„ä¸¤ä¸ªå¯¹é˜Ÿåˆ—å¤´ï¼Œè¯¦æƒ…è¯·è§5.1èŠ‚ã€‚

4.1.3 å¯åŠ¨ä¼ è¾“
myuvc_vidioc_streamonï¼Œå¯åŠ¨ä¼ è¾“ã€‚

 åœ¨å®Œæˆäº†å±æ€§è®¾ç½®ï¼Œä»¥åŠæ„é€ æ•°æ®é˜Ÿåˆ—ä»¥åï¼Œå³å°†å¼€å§‹UVCæœ€å¤æ‚çš„ä¸€éƒ¨åˆ†ï¼šæ•°æ®ä¼ è¾“ã€‚æ•°æ®ä¼ è¾“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼šé€šè¿‡msgå‘ç¡¬ä»¶ä¼ é€’å‚æ•°ï¼›åˆ†é…æ„é€ urbåŒ…ã€‚

 ä¼ è¾“ç”¨åˆ°çš„æ˜¯VideoStreamæ¥å£ï¼Œéœ€è¦å•ç‹¬è®¾ç½®å¯åŠ¨çš„å‚æ•°ï¼Œåœ¨è¿™é‡Œï¼Œå¯åŠ¨å‚æ•°ç”¨msgåŒ…è¿›è¡Œä¼ è¾“ï¼ŒVSæ¥å£æ‰€éœ€çš„å‚æ•°å¦‚ä¸‹ç»“æ„ä½“ï¼š

struct myuvc_streaming_control {
	__u16 bmHint;
	__u8  bFormatIndex;
	__u8  bFrameIndex;
	__u32 dwFrameInterval;
	__u16 wKeyFrameRate;
	__u16 wPFrameRate;
	__u16 wCompQuality;
	__u16 wCompWindowSize;
	__u16 wDelay;
	__u32 dwMaxVideoFrameSize;
	__u32 dwMaxPayloadTransferSize;
	__u32 dwClockFrequency;
	__u8  bmFramingInfo;
	__u8  bPreferedVersion;
	__u8  bMinVersion;
	__u8  bMaxVersion;
};
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œç”¨åˆ°å‰è¾¹è®¾ç½®å¥½çš„å±æ€§å’Œå‚æ•°ï¼Œè¿™ä¸ªç»“æ„ä½“çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡æ‰‹åŠ¨é€æ¡è®¾ç½®ï¼Œä½†æ˜¯å†…æ ¸æä¾›äº†ç‹¬ç‰¹çš„æ–¹æ³•ï¼Œå¯ç›´æ¥é€šè¿‡USBçš„æè¿°ç¬¦ä¸­è§£æå‡ºæ¥ã€‚

static int myuvc_vidioc_streamon(struct file *file, void *priv, enum v4l2_buf_type i)
{
    int ret;
    /* a. æµ‹è¯•å‚æ•° */
    ret = myuvc_try_streaming_params(&myuvc_params);
    printk("myuvc_try_streaming_params ret = %d\n", ret);

    /* b. å–å‡ºå‚æ•° */
    ret = myuvc_get_streaming_params(&myuvc_params);
    printk("myuvc_get_streaming_params ret = %d\n", ret);
    
    /* c. è®¾ç½®å‚æ•° */
    ret = myuvc_set_streaming_params(&myuvc_params);
    printk("myuvc_set_streaming_params ret = %d\n", ret);
1
2
3
4
5
6
7
8
9
10
11
12
13
14
åœ¨streamonä¸­ï¼Œè°ƒç”¨ä¸‰ä¸ªå°è£…å¥½çš„å‡½æ•°ï¼Œç”¨ç±»ä¼¼äºä¸Šæ–‡å‚æ•°è·å–çš„æ–¹æ³•ï¼Œæµ‹è¯•ã€å–å‡ºå¹¶è®¾ç½®å‚æ•°ã€‚å…·ä½“çš„è®¾ç½®è¿‡ç¨‹ä¸å¤šèµ˜è¿°ï¼Œä¸‹é¢ä¸»è¦æ¥çœ‹ä¸€çœ‹å‚æ•°æ˜¯å¦‚ä½•ä¼ é€’ç»™ç¡¬ä»¶çš„ã€‚

static int myuvc_try_streaming_params(struct myuvc_streaming_control *ctrl)
{
	... ...
    pipe = (SET_CUR & 0x80) ? usb_rcvctrlpipe(myuvc_udev, 0)
                  : usb_sndctrlpipe(myuvc_udev, 0);
    type |= (SET_CUR & 0x80) ? USB_DIR_IN : USB_DIR_OUT;

    ret = usb_control_msg(myuvc_udev, pipe, SET_CUR, type, VS_PROBE_CONTROL << 8,
            0 << 8 | myuvc_streaming_intf, data, size, 5000);
    ... ...
}
1
2
3
4
5
6
7
8
9
10
11
ä¸Šå›¾è°ƒç”¨usb_control_msgå‡½æ•°ï¼Œå°†è®¾ç½®å¥½çš„msgåŒ…ä¼ é€’åˆ°ç¡¬ä»¶ã€‚ä¸‹é¢æ¥çœ‹çœ‹tryã€setã€getçš„åŒºåˆ«ï¼š

static int myuvc_get_streaming_params(struct myuvc_streaming_control *ctrl)
{
	... ...
	pipe = (GET_CUR & 0x80) ? usb_rcvctrlpipe(myuvc_udev, 0)
			      : usb_sndctrlpipe(myuvc_udev, 0);
	type |= (GET_CUR & 0x80) ? USB_DIR_IN : USB_DIR_OUT;

	ret = usb_control_msg(myuvc_udev, pipe, GET_CUR, type, VS_PROBE_CONTROL << 8,
			0 << 8 | myuvc_streaming_intf, data, size, 5000);
	... ...
}
1
2
3
4
5
6
7
8
9
10
11
 getå’Œtryçš„åŒºåˆ«åœ¨äºï¼šåˆ†åˆ«ä¸ºSET_CURä¸GET_CURæ ‡å¿—ï¼ŒäºŒè€…éƒ½æ˜¯VS_PROBE_CONTROLï¼Œä»£è¡¨åªæ˜¯è¿æ¥è¿‡ç¨‹ï¼Œå¹¶éçœŸæ­£çš„è®¾ç½®è¿‡ç¨‹ã€‚

static int myuvc_set_streaming_params(struct myuvc_streaming_control *ctrl)
{
    ... ...
    pipe = (SET_CUR & 0x80) ? usb_rcvctrlpipe(myuvc_udev, 0)
                  : usb_sndctrlpipe(myuvc_udev, 0);
    type |= (SET_CUR & 0x80) ? USB_DIR_IN : USB_DIR_OUT;

    ret = usb_control_msg(myuvc_udev, pipe, SET_CUR, type, VS_COMMIT_CONTROL << 8,
            0 << 8 | myuvc_streaming_intf, data, size, 5000);
    
    ... ...
}
1
2
3
4
5
6
7
8
9
10
11
12
 tryå’ŒsetåŒºåˆ«åœ¨äºï¼šäºŒè€…æ ‡å¿—éƒ½æ˜¯SET_CURï¼Œä½†åˆ†åˆ«ä¸ºVS_PROBE_CONTROLå’ŒVS_COMMIT_CONTROLï¼Œä»£è¡¨tryæ˜¯è¿æ¥è¿‡ç¨‹ï¼Œsetæ˜¯æœ€ç»ˆç¡®è®¤è¿‡ç¨‹ã€‚

 urbåŒ…ç±»ä¼¼äºç½‘ç»œsocketç¼–ç¨‹ä¸­çš„sk_bufåŒ…ï¼Œç”¨äºusbåè®®ä¸­ç¡¬ä»¶ä¸ŠæŠ¥ä¼ è¾“æ•°æ®ã€‚åœ¨streamonå‡½æ•°ä¸­ï¼Œåˆ†é…

å¹¶è®¾ç½®ï¼Œåœ¨å‘åŒ…å‰ï¼Œè¿˜éœ€è¦ä¸€ä¸ªæ¥å£è®¾ç½®ï¼Œusb_set_interfaceã€‚æ¥è®¾ç½®å¸¦å®½ï¼šæ ¹æ®settingçš„endpointèƒ½ä¼ è¾“çš„wMaxPacketSizeï¼Œæ‰¾åˆ°èƒ½æ»¡è¶³è¯¥å¸¦å®½çš„settingã€‚

    usb_set_interface(myuvc_udev, myuvc_streaming_intf,myuvc_streaming_bAlternateSetting);
    
    ret = myuvc_alloc_init_urbs();
    if (ret)
        printk("myuvc_alloc_init_urbs err : ret = %d\n", ret);
1
2
3
4
5
 æœ€åï¼Œæäº¤URBåŒ…ï¼Œå‡†å¤‡å¼€å§‹æ¥å—æ•°æ®ï¼š

	for (i = 0; i < MYUVC_URBS; ++i) {
		if ((ret = usb_submit_urb(myuvc_queue.urb[i], GFP_KERNEL)) < 0) {
			printk("Failed to submit URB %u (%d).\n", i, ret);
			myuvc_uninit_urbs();
			return ret;
		}
	}
	
	return 0;
}
1
2
3
4
5
6
7
8
9
10
 è‡³æ­¤ï¼ŒSTREAMONå¯åŠ¨å…¨éƒ¨å®Œæˆã€‚

4.1.4 æŸ¥è¯¢è·å–æ•°æ®
 æ¥ä¸‹æ¥å°±å¯ä»¥å¼€å§‹ä»ç¡¬ä»¶æ¥å—æ•°æ®äº†ã€‚

myuvc_pollï¼ŒAPPè°ƒç”¨POLL/selectæ¥ç¡®å®šç¼“å­˜æ˜¯å¦å°±ç»ª(æœ‰æ•°æ®) ã€‚

ä»mainqueueé˜Ÿåˆ—å¤´ä¸­ï¼Œå–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œè‹¥æœªå°±ç»ªï¼Œåˆ™ä¼‘çœ ç­‰å¾…ã€‚

    buf = list_first_entry(&myuvc_queue.mainqueue, struct myuvc_buffer, stream);
    
    poll_wait(file, &buf->wait, wait);
1
2
3
myuvc_vidioc_dqbufï¼Œè‹¥æœ‰æ•°æ®ï¼Œåˆ™æŠŠç¼“å­˜ä»é˜Ÿåˆ—å–å‡ºï¼Œmmapæ˜ å°„è¿‡å†…å­˜ï¼Œæ‰€ä»¥APPå¯ç›´æ¥æ“ä½œç¼“å­˜ã€‚

	buf = list_first_entry(&myuvc_queue.mainqueue, struct myuvc_buffer, stream);
	
	switch (buf->state) {
	case VIDEOBUF_ERROR:
		ret = -EIO;
	case VIDEOBUF_DONE:
		buf->state = VIDEOBUF_IDLE;
		break;
	
	case VIDEOBUF_IDLE:
	case VIDEOBUF_QUEUED:
	case VIDEOBUF_ACTIVE:
	default:
		ret = -EINVAL;
		goto done;
	}
	
	list_del(&buf->stream);
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
è‹¥æœ‰æ•°æ®ï¼Œåˆ™å–å‡ºbuf1ï¼Œå¤„ç†å®Œæ•°æ®åï¼Œå…¥åˆ—åˆ°é˜Ÿåˆ—mainqueueå°¾éƒ¨ã€‚å¹¶æ›´æ–°äº†ç¼“å†²åŒºçŠ¶æ€ã€‚

é‡å¤æŸ¥è¯¢ã€è·å–â€¦

myuvc_vidioc_streamoffï¼Œä¼ è¾“ç»“æŸï¼Œåœæ­¢ã€‚

static int myuvc_vidioc_streamoff(struct file *file, void *priv, enum v4l2_buf_type t)
{
	struct urb *urb;
	unsigned int i;

    /* 1. kill URB */
    for (i = 0; i < MYUVC_URBS; ++i) {
    	if ((urb = myuvc_queue.urb[i]) == NULL)
    		continue;
    	usb_kill_urb(urb);
    }
    
    /* 2. free URB */
    myuvc_uninit_urbs();
    
    /* 3. è®¾ç½®VideoStreaming Interfaceä¸ºsetting 0 */
    usb_set_interface(myuvc_udev, myuvc_streaming_intf, 0);
    
    return 0;
}
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
 è°ƒç”¨streamoffå…³é—­ä¼ è¾“ï¼Œä¸»è¦åšäº†ä¸‰éƒ¨åˆ†å·¥ä½œï¼š

 æ¸…ç©ºurbåŒ…ï¼Œé‡Šæ”¾urbç¼“å†²å†…å­˜ï¼Œå°†VSä¼ è¾“æ¥å£å…³é—­ã€‚

ä»¥ä¸Šå°±æ˜¯UVCé©±åŠ¨ä¼ è¾“çš„å…¨è¿‡ç¨‹ã€‚å¯ä»¥çœ‹å‡ºï¼ŒUVCé©±åŠ¨æ¯”è¾ƒå¤æ‚ï¼Œéš¾ç‚¹é›†ä¸­åœ¨å¯åŠ¨ä¼ è¾“è¿‡ç¨‹ä¸­ã€‚

4.2 å±æ€§è®¾ç½®
æ¥ä¸‹æ¥æ˜¯æ¯”è¾ƒè½»æ¾çš„å±æ€§è®¾ç½®ç¯èŠ‚ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š

 /* æŸ¥è¯¢/è·å¾—/è®¾ç½®å±æ€§ */

 .vidioc_queryctrl = myuvc_vidioc_queryctrl,

 .vidioc_g_ctrl = myuvc_vidioc_g_ctrl,

 .vidioc_s_ctrl = myuvc_vidioc_s_ctrl,

ä¾æ¬¡åˆ†æã€‚

myuvc_vidioc_queryctrlï¼ŒæŸ¥è¯¢USBè®¾å¤‡æ”¯æŒè®¾ç½®çš„å±æ€§å€¼ã€‚å±æ€§è®¾ç½®å±äºVideoControlæ¥å£ï¼ŒåŒæ ·ï¼Œå¯ä»¥æ ¹æ®USBçš„æè¿°ç¬¦ï¼Œå®šä½åˆ°å¯ä»¥è®¾ç½®çš„å±æ€§ï¼ŒæŸ¥è¯¢çš„åˆ°è®¾å¤‡å¯ä»¥è®¾ç½®äº®åº¦ï¼š
	memset(ctrl, 0, sizeof *ctrl);
	ctrl->id   = V4L2_CID_BRIGHTNESS;
	ctrl->type = V4L2_CTRL_TYPE_INTEGER;
	strcpy(ctrl->name, "MyUVC_BRIGHTNESS");
	ctrl->flags = 0;
1
2
3
4
5
æŸ¥è¯¢åˆ°äº®åº¦å¯è°ƒèŠ‚ï¼Œä½†æ˜¯è°ƒèŠ‚çš„ç»†èŠ‚è¿˜éœ€è¦ç¡®è®¤ï¼Œç¡®è®¤è¿‡ç¨‹åŒæ ·æ˜¯ä¾èµ–MSGåŒ…ï¼š

æŸ¥è¯¢äº®åº¦è°ƒèŠ‚çš„æœ€å°å€¼ï¼š

	ret = usb_control_msg(myuvc_udev, pipe, GET_MIN, type, PU_BRIGHTNESS_CONTROL << 8,
			ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);
	if (ret != 2)
	    return -EIO;
	ctrl->minimum = myuvc_get_le_value(data);	/* Note signedness */

1
2
3
4
5
6
æŸ¥è¯¢äº®åº¦è°ƒèŠ‚æœ€å¤§å€¼ï¼š

	ret = usb_control_msg(myuvc_udev, pipe, GET_MAX, type,  PU_BRIGHTNESS_CONTROL << 8,
			ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);
	if (ret != 2)
	    return -EIO;
	ctrl->maximum = myuvc_get_le_value(data);	/* Note signedness */
1
2
3
4
5
æŸ¥è¯¢äº®åº¦è°ƒèŠ‚çš„æ­¥é˜¶ï¼š

	ret = usb_control_msg(myuvc_udev, pipe, GET_RES, type, PU_BRIGHTNESS_CONTROL << 8,
			 ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);
	if (ret != 2)
	    return -EIO;
	
	ctrl->step = myuvc_get_le_value(data);	/* Note signedness */
1
2
3
4
5
6
æŸ¥è¯¢äº®åº¦è°ƒèŠ‚çš„é»˜è®¤å€¼ï¼š

ret = usb_control_msg(myuvc_udev, pipe, GET_DEF, type, PU_BRIGHTNESS_CONTROL << 8,
		ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);
if (ret != 2)
    return -EIO;
ctrl->default_value = myuvc_get_le_value(data);	/* Note signedness */
1
2
3
4
5


myuvc_vidioc_g_ctrlï¼Œç”¨äºè·å–å±æ€§ã€‚

	ret = usb_control_msg(myuvc_udev, pipe, GET_CUR, type, PU_BRIGHTNESS_CONTROL << 8,
			ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);
	if (ret != 2)
	    return -EIO;
	ctrl->value = myuvc_get_le_value(data);	/* Note signedness */
1
2
3
4
5
myuvc_vidioc_s_ctrlï¼Œæœ€ç»ˆçš„å±æ€§è®¾ç½®ã€‚

    ret = usb_control_msg(myuvc_udev, pipe, SET_CUR, type, PU_BRIGHTNESS_CONTROL << 8,
            ProcessingUnitID  << 8 | myuvc_control_intf, data, 2, 5000);
1
2
ä»¥ä¸Šä»¥äº®åº¦è°ƒèŠ‚ä½œä¸ºä¾‹å­ï¼Œåˆ†æå­¦ä¹ äº†å±æ€§è°ƒèŠ‚çš„è¿‡ç¨‹ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ªUVCé©±åŠ¨æ­£å¼å®Œæˆã€‚

äº”ã€é—®é¢˜ä¸è§£å†³
5.1 ä¸¤ä¸ªé˜Ÿåˆ—å¤´æ§åˆ¶åŒä¸€ä¸ªé˜Ÿåˆ—
 åœ¨é©±åŠ¨å¯åŠ¨ä¼ è¾“åï¼Œç”¨ä¸¤ä¸ªé˜Ÿåˆ—å¤´æ¥ç®¡ç†ç¼“å­˜é˜Ÿåˆ—ï¼šmainqueueï¼Œirqqueueã€‚å½“åº•å±‚æœ‰æ•°æ®æ—¶ï¼Œä»irqueueé˜Ÿåˆ—å–å‡ºç¬¬ä¸€ä¸ªç¼“å­˜ï¼Œå°†æ•°æ®æ”¾å…¥ç¼“å­˜ä¸­ã€‚

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-qd6ZfhPL-1605407372974)(C:\Users\Administrator\Desktop\æ‘„åƒå¤´é©±åŠ¨â€”â€”UVCé©±åŠ¨åˆ†æåŠç¼–å†™\é˜Ÿåˆ—1.png)]

 å½“ç¡¬ä»¶äº§ç”Ÿæ•°æ®ï¼Œä»irqqueueå–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œåœ¨buf1ä¸­å¡«å……æ•°æ®ï¼š

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-McpcorP0-1605407372976)(C:\Users\Administrator\Desktop\æ‘„åƒå¤´é©±åŠ¨â€”â€”UVCé©±åŠ¨åˆ†æåŠç¼–å†™\irqé˜Ÿåˆ—.png)]

 åº”ç”¨ç¨‹åºé€šè¿‡pollè°ƒç”¨ï¼ŒæŸ¥è¯¢åˆ°mainqueueä¸­æœ‰æ•°æ®ï¼Œåˆ™ä»mainqueueé˜Ÿåˆ—å–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œå–å‡ºbuf1ä¸­çš„æ•°æ®ï¼Œå¹¶æ¸…ç©ºbuf1ï¼š

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-c9ohz5N3-1605407372978)(C:\Users\Administrator\Desktop\æ‘„åƒå¤´é©±åŠ¨â€”â€”UVCé©±åŠ¨åˆ†æåŠç¼–å†™\mainé˜Ÿåˆ—.png)]

 æœ€åï¼Œè¢«æ¸…ç©ºçš„buf1ä¼šè¢«å…¥åˆ—åˆ°é˜Ÿå°¾ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„æ•°æ®ä¼ è¾“ï¼š

[å¤–é“¾å›¾ç‰‡è½¬å­˜å¤±è´¥,æºç«™å¯èƒ½æœ‰é˜²ç›—é“¾æœºåˆ¶,å»ºè®®å°†å›¾ç‰‡ä¿å­˜ä¸‹æ¥ç›´æ¥ä¸Šä¼ (img-uOV3GrPn-1605407372979)(C:\Users\Administrator\Desktop\æ‘„åƒå¤´é©±åŠ¨â€”â€”UVCé©±åŠ¨åˆ†æåŠç¼–å†™\è¯»å–ç»“æŸé˜Ÿåˆ—.png)]

 è‡³æ­¤ï¼Œä¸€æ¬¡æ•°æ®è¯»å–è¿‡ç¨‹ç»“æŸã€‚

5.2 urbåŒ…çš„æ„é€ 
 urbåŒ…ç±»ä¼¼äºç½‘ç»œsocketç¼–ç¨‹ä¸­çš„sk_bufåŒ…ï¼Œç”¨äºusbåè®®ä¸­ç¡¬ä»¶ä¸ŠæŠ¥ä¼ è¾“æ•°æ®ã€‚æ³¨æ„ï¼ŒURBåªæ˜¯ç¡¬ä»¶åˆ°é©±åŠ¨å±‚çš„æ•°æ®ä¼ é€’ï¼Œé©±åŠ¨é€šè¿‡pollæŸ¥è¯¢åˆ°æ•°æ®å­˜åœ¨åï¼Œä¼šå°†URBåŒ…è§£æï¼Œå¹¶å°†æ•°æ®æ”¾å…¥irqqueueé˜Ÿåˆ—ã€‚



8,
ProcessingUnitID << 8 | myuvc_control_intf, data, 2, 5000);


ä»¥ä¸Šä»¥äº®åº¦è°ƒèŠ‚ä½œä¸ºä¾‹å­ï¼Œåˆ†æå­¦ä¹ äº†å±æ€§è°ƒèŠ‚çš„è¿‡ç¨‹ï¼Œåˆ°æ­¤ï¼Œä¸€ä¸ªUVCé©±åŠ¨æ­£å¼å®Œæˆã€‚



# äº”ã€é—®é¢˜ä¸è§£å†³



## 5.1 waitqueueå’Œirqqueueé˜Ÿåˆ—</a>

		åœ¨é©±åŠ¨å¯åŠ¨ä¼ è¾“åï¼Œç”¨ä¸¤ä¸ªé˜Ÿåˆ—å¤´æ¥ç®¡ç†ç¼“å­˜é˜Ÿåˆ—ï¼šmainqueueï¼Œirqqueueã€‚å½“åº•å±‚æœ‰æ•°æ®æ—¶ï¼Œä»irqueueé˜Ÿåˆ—å–å‡ºç¬¬ä¸€ä¸ªç¼“å­˜ï¼Œå°†æ•°æ®æ”¾å…¥ç¼“å­˜ä¸­ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201115103323666.png#pic_center)
å½“ç¡¬ä»¶äº§ç”Ÿæ•°æ®ï¼Œä»irqqueueå–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œåœ¨buf1ä¸­å¡«å……æ•°æ®ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201115103323654.png#pic_center)
åº”ç”¨ç¨‹åºé€šè¿‡pollè°ƒç”¨ï¼ŒæŸ¥è¯¢åˆ°mainqueueä¸­æœ‰æ•°æ®ï¼Œåˆ™ä»mainqueueé˜Ÿåˆ—å–å‡ºç¬¬ä¸€ä¸ªbuf1ï¼Œå–å‡ºbuf1ä¸­çš„æ•°æ®ï¼Œå¹¶æ¸…ç©ºbuf1ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201115103505203.png#pic_center)

æœ€åï¼Œè¢«æ¸…ç©ºçš„buf1ä¼šè¢«å…¥åˆ—åˆ°é˜Ÿå°¾ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡çš„æ•°æ®ä¼ è¾“ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/20201115103323665.png#pic_center)
		è‡³æ­¤ï¼Œä¸€æ¬¡æ•°æ®è¯»å–è¿‡ç¨‹ç»“æŸã€‚



## 5.2 urbåŒ…çš„æ„é€ 

		urbåŒ…ç±»ä¼¼äºç½‘ç»œsocketç¼–ç¨‹ä¸­çš„sk_bufåŒ…ï¼Œç”¨äºusbåè®®ä¸­ç¡¬ä»¶ä¸ŠæŠ¥ä¼ è¾“æ•°æ®ã€‚æ³¨æ„ï¼ŒURBåªæ˜¯ç¡¬ä»¶åˆ°é©±åŠ¨å±‚çš„æ•°æ®ä¼ é€’ï¼Œé©±åŠ¨é€šè¿‡pollæŸ¥è¯¢åˆ°æ•°æ®å­˜åœ¨åï¼Œä¼šå°†URBåŒ…è§£æï¼Œå¹¶å°†æ•°æ®æ”¾å…¥irqqueueé˜Ÿåˆ—ã€‚


â€‹		










































â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºCSDNåšä¸»ã€Œchenshi_linuxqtã€çš„åŸåˆ›æ–‡ç« ï¼Œéµå¾ªCC 4.0 BY-SAç‰ˆæƒåè®®ï¼Œè½¬è½½è¯·é™„ä¸ŠåŸæ–‡å‡ºå¤„é“¾æ¥åŠæœ¬å£°æ˜ã€‚
åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/aprqe/article/details/109700984
